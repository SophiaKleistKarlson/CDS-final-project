---
title: "Preprocessing Conventionality"
author: "Sophia Kleist Karlson"
date: "22 nov 2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)


pacman::p_load(tidyverse, jsonlite, rjson, stringr, dplyr)

setwd("~/Social Transmission Study/Analysis of drawings/")

RStudio.Version() #why this?
```




importing conventionality data from round 1
```{r}

#specifying data path
data_path_m <- 'data/mturk/round_1' 

#creating a list of files
list_files_m <- list.files(path = data_path_m,
                         recursive = T,
                         pattern = "session.json$",
                         full.names = T)

data_path_m
list_files_m

length(list_files_m)

# empty data fame with the correct column names
all_data_m <- data.frame(matrix(ncol = 1, nrow = 0)) #ncol doesn't actually make a difference



# extract all mturk files and 
for (i in 1:length(list_files_m)){
  file_path_m <- list_files_m[i]
  d_m <- jsonlite::fromJSON(file_path_m, flatten=T) %>% 
    select(drawing_id, button_pressed, completion_code) %>% 
    rename(Drawing_ID = drawing_id,
           Conventionality = button_pressed) %>% 
    filter(is.na(Drawing_ID) + is.na(completion_code) < 2 ,)
  if (nrow(all_data_m) == 0){
    all_data_m <- d_m
  } else {
    all_data_m <- rbind(all_data_m, d_m)
  }
}


# check class of conventionality - it should be numeric
class(all_data_m$Conventionality)
all_data_m$Conventionality <- as.numeric(all_data_m$Conventionality)

# look at mean, sd and range of conventionality
mean(all_data_m$Conventionality)
sd(all_data_m$Conventionality)
range(all_data_m$Conventionality)
```



importing conventionality data from round 2
```{r}

#specifying data path
data_path_m_2 <- 'data/mturk/round_2' 

#creating a list of files
list_files_m_2 <- list.files(path = data_path_m_2,
                         recursive = T,
                         pattern = "session.json$",
                         full.names = T)

data_path_m_2
list_files_m_2
length(list_files_m_2)

# empty data fame with the correct column names
all_data_m_2 <- data.frame(matrix(ncol = 1, nrow = 0)) #ncol doesn't actually make a difference



# extract all mturk files and 
for (i in 1:length(list_files_m_2)){
  file_path_m_2 <- list_files_m_2[i]
  d_m_2 <- jsonlite::fromJSON(file_path_m_2, flatten=T) %>% 
    select(drawing_id, button_pressed, completion_code) %>% 
    rename(Drawing_ID = drawing_id,
           Conventionality = button_pressed) %>% 
    filter(is.na(Drawing_ID) + is.na(completion_code) < 2 ,)
  if (nrow(all_data_m_2) == 0){
    all_data_m_2 <- d_m_2
  } else {
    all_data_m_2 <- rbind(all_data_m_2, d_m_2)
  }
}

# check class and make numeric 
class(all_data_m_2$Conventionality)
all_data_m_2$Conventionality <- as.numeric(all_data_m_2$Conventionality)

# check mean, sd and range
mean(all_data_m_2$Conventionality)
sd(all_data_m_2$Conventionality)
range(all_data_m_2$Conventionality)

```



Make lists of completion codes from Mechanical Turk
```{r}

# make list of completion codes from round 1 
completion_codes <- all_data_m$completion_code 
completion_codes <- completion_codes[complete.cases(completion_codes)]

# completion codes for round 2
completion_codes_2 <- all_data_m_2$completion_code 
completion_codes_2 <- completion_codes_2[complete.cases(completion_codes_2)]

# write lists as csv
write.csv(completion_codes, "data/csv_files/completion_codes.csv") # completion codes 1
write.csv(completion_codes_2, "data/csv_files/completion_codes_2.csv") # completion codes 2

```



Make extra rows for source images for each chain - we use all_data_2
```{r}

all_data_2 <- read.csv("data/csv_files/data_w_complexity.csv")
all_data_2$X <- NULL

# make new dataframe from all_data_2
all_data_w_source <- all_data_2

# add 240 empty rows to be filled with source images in the beginning of each chain
all_data_w_source[nrow(all_data_w_source)+240,] <- NA

# check class of generation column
class(all_data_w_source$Generation)

# make every generation 1 higher
all_data_w_source <- all_data_w_source %>% mutate(Generation = Generation +1)



# read csv with complexity of source images
source_comp <- read.csv("data/source_images/complexity/complexity_comparison_source.csv")
source_comp$X <- NULL

# add generation column which is 0
source_comp$Generation <- rep(0,12)

# add source image column, which is just the drawing id without "stim_"
source_comp <- source_comp %>% mutate(Source_image = str_replace_all(Drawing_ID, 'stim_', ''))

# make drawing id into character
class(source_comp$Drawing_ID)
source_comp$Drawing_ID <- as.character(source_comp$Drawing_ID)


# add columns from source_comp to all_data_w_source
all_data_w_source[1681:1692,1] <- source_comp$Drawing_ID
all_data_w_source[1681:1692,7] <- source_comp$Generation
all_data_w_source[1681:1692,9] <- source_comp$Source_image
all_data_w_source[1681:1692,15] <- source_comp$Complexity_original
all_data_w_source[1681:1692,16] <- source_comp$Complexity_convolution

# add chain id
all_data_w_source[1681:1692,6] <- rep(0,12)

# not very tidy, but it works
all_data_w_source[1693:1704,] <- all_data_w_source[1681:1692,]

# column 6 is chain
all_data_w_source[1693:1704,6] <- rep(12,12) # chain 12

# do the same with the rest of the source image rows:
all_data_w_source[1705:1716,] <- all_data_w_source[1681:1692,]
all_data_w_source[1705:1716,6] <- rep(13,12) # chain 13

all_data_w_source[1717:1728,] <- all_data_w_source[1681:1692,]
all_data_w_source[1717:1728,6] <- rep(14,12) # chain 14

all_data_w_source[1729:1740,] <- all_data_w_source[1681:1692,]
all_data_w_source[1729:1740,6] <- rep(15,12) # chain 15
                  
all_data_w_source[1741:1752,] <- all_data_w_source[1681:1692,]
all_data_w_source[1741:1752,6] <- rep(16,12)

all_data_w_source[1753:1764,] <- all_data_w_source[1681:1692,]
all_data_w_source[1753:1764,6] <- rep(17,12)

all_data_w_source[1765:1776,] <- all_data_w_source[1681:1692,]
all_data_w_source[1765:1776,6] <- rep(18,12)

all_data_w_source[1777:1788,] <- all_data_w_source[1681:1692,]
all_data_w_source[1777:1788,6] <- rep(19,12)

all_data_w_source[1789:1800,] <- all_data_w_source[1681:1692,]
all_data_w_source[1789:1800,6] <- rep(2,12)

all_data_w_source[1801:1812,] <- all_data_w_source[1681:1692,]
all_data_w_source[1801:1812,6] <- rep(20,12)

all_data_w_source[1813:1824,] <- all_data_w_source[1681:1692,]
all_data_w_source[1813:1824,6] <- rep(21,12)

all_data_w_source[1825:1836,] <- all_data_w_source[1681:1692,]
all_data_w_source[1825:1836,6] <- rep(22,12)

all_data_w_source[1837:1848,] <- all_data_w_source[1681:1692,]
all_data_w_source[1837:1848,6] <- rep(23,12)

all_data_w_source[1849:1860,] <- all_data_w_source[1681:1692,]
all_data_w_source[1849:1860,6] <- rep(3,12)

all_data_w_source[1861:1872,] <- all_data_w_source[1681:1692,]
all_data_w_source[1861:1872,6] <- rep(4,12)

all_data_w_source[1873:1884,] <- all_data_w_source[1681:1692,]
all_data_w_source[1873:1884,6] <- rep(5,12)

all_data_w_source[1885:1896,] <- all_data_w_source[1681:1692,]
all_data_w_source[1885:1896,6] <- rep(7,12)

all_data_w_source[1897:1908,] <- all_data_w_source[1681:1692,]
all_data_w_source[1897:1908,6] <- rep(8,12)

all_data_w_source[1909:1920,] <- all_data_w_source[1681:1692,]
all_data_w_source[1909:1920,6] <- rep(9,12)


for (i in 1:1920){
  # if generation is 0 (which is only true for source image rows)
  for (c in 0:23){
    for (s in 1:12){
      if (all_data_w_source[i, 6] == c & all_data_w_source[i, 7] == 0 & all_data_w_source[i, 9] == s){
        for (j in 1:1920){
          if (all_data_w_source[j, 6] == c & all_data_w_source[j, 7] == 1 & all_data_w_source[j, 9] == s){
            all_data_w_source[i, 8] <- all_data_w_source[j, 8]
          }
        }
      }
    }
  }
}

```



Merge dataframes and save csv's
```{r}

# rbind conventionality 1 and conventionality 2 scores
all_conventionality <- rbind(all_data_m_2, all_data_m)
all_conventionality$completion_code <- NULL

# save all conventionality scores as csv
write.csv(all_conventionality, "data/csv_files/all_conventionality.csv")


# merge conventionality data with the dataset containing source images as gen 0 for each chain
all_data_w_all_conv_source <- merge(all_conventionality, all_data_w_source)

# write csv
write.csv(all_data_w_all_conv_source, "data/csv_files/all_data_w_all_conv_source.csv")
```

